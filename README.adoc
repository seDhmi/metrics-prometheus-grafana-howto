= Expose Vert.x Metrics for Prometheus, visualize in Grafana
:page-permalink: /
:page-github: vertx-howtos/metrics-prometheus-grafana-howto

ifdef::env-github[]
image:https://travis-ci.org/vertx-howtos/metrics-prometheus-grafana-howto.svg?branch=master["Build Status", link="https://travis-ci.org/vertx-howtos/metrics-prometheus-grafana-howto"]
endif::env-github[]

This document will show you how to expose Vert.x Metrics for Prometheus and visualize them in Grafana.

== What you will build

You will build a web server that:

- generates greetings upon request on the `EventBus`
- replies to `GET` requests on the `/greeting` path,
- exposes metrics for Prometheus on the `/metrics` path.

Then you will configure Prometheus to scrape the metrics and Grafana to visualize them.

The application consists in a single file, the `MainVerticle` class

== What you need

* A text editor or IDE
* Java 8 higher
* Maven or Gradle
* Prometheus (or Docker)
* Grafana (or Docker)

== Create a project

The code of this project contains Maven and Gradle build files that are functionally equivalent.

=== Using Maven

Here is the content of the `pom.xml` file you should be using:

ifdef::env-github[]
link:pom.xml[Maven POM file]
endif::env-github[]
ifndef::env-github[]
[source,xml,role="collapsed"]
.Maven `pom.xml`
----
include::pom.xml[]
----
endif::env-github[]

=== Using Gradle

Assuming you use Gradle with the Kotlin DSL, here is what your `build.gradle.kts` file should look like:

ifdef::env-github[]
link:build.gradle.kts[Gradle build file]
endif::env-github[]
ifndef::env-github[]
[source,kotlin,role="collapsed"]
.Gradle `build.gradle.kts`
----
include::build.gradle.kts[]
----
endif::env-github[]

== Implementing the server

=== Greeting generator

First, let's define a few greetings:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle greetings constant]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=greetings]
----
endif::env-github[]

Then, we will define a consumer for the `greetings` address on the `EventBus`.
This consumer picks a random greeting and returns it after an arbitrary amount of time:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle consumer]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=consumer]
----
endif::env-github[]

=== HTTP server

We'll need a Vert.x Web Router to start with:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle router]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=router]
----
endif::env-github[]

Then let's create a handler for `GET` requests on the `greeting` path:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle handler]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=handler]
----
endif::env-github[]

The Vert.x Micrometer Metrics module provides a Vert.x Web handler that comes in handy when you need to expose data in the Prometheus text format:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle scraping]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=scraping]
----
endif::env-github[]

With the Vert.x Web Router configured, we can start the HTTP server:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle http]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=http]
----
endif::env-github[]

// FIXME: explain the histogram part

Lastly, the `MainVerticle` needs a `main` method:

ifdef::env-github[]
link:src/main/java/io/vertx/howtos/metrics/MainVerticle.java[MainVerticle main method]
endif::env-github[]
ifndef::env-github[]
[source,java,role="collapsed"]
.Java `src/main/java/io/vertx/howtos/metrics/MainVerticle.java`
----
include::src/main/java/io/vertx/howtos/metrics/MainVerticle.java[tag=main]
----
endif::env-github[]

IMPORTANT: The Vert.x instance must be created with metrics options enabled.

== Running the application

You can run the application:

* straight from your IDE or,
* with Maven: `mvn compile exec:java`, or
* with Gradle: `./gradlew run` (Linux, macOS) or `gradlew run` (Windows).

The following examples use the https://httpie.org/[HTTPie] command line HTTP client.
Please refer to the https://httpie.org/doc#installation[installation] documentation if you don't have it installed on your system yet.

=== Testing the greeting server

To get a greeting from the server, open your terminal and execute this:

[source,shell]
----
http :8080/greeting
----

You should see something like:

----
HTTP/1.1 200 OK
content-length: 11
content-type: text/plain

Hola Mundo!

----

=== Testing the metrics endpoint

To get the metrics:

[source,shell]
----
http :8080/metrics
----

// FIXME
You should see something like:

----
HTTP/1.1 200 OK
content-length: 3741
content-type: text/plain; version=0.0.4; charset=utf-8

# HELP vertx_eventbus_pending Number of messages not processed yet
# TYPE vertx_eventbus_pending gauge
vertx_eventbus_pending{side="local",} 0.0
# HELP vertx_http_server_response_time_seconds_max Request processing time
# TYPE vertx_http_server_response_time_seconds_max gauge
vertx_http_server_response_time_seconds_max{code="200",method="GET",route="/greeting",} 0.134909966
vertx_http_server_response_time_seconds_max{code="200",method="GET",route="/metrics",} 0.006705547
# HELP vertx_http_server_response_time_seconds Request processing time
# TYPE vertx_http_server_response_time_seconds summary
vertx_http_server_response_time_seconds_count{code="200",method="GET",route="/greeting",} 1.0
vertx_http_server_response_time_seconds_sum{code="200",method="GET",route="/greeting",} 0.134909966
vertx_http_server_response_time_seconds_count{code="200",method="GET",route="/metrics",} 4.0
vertx_http_server_response_time_seconds_sum{code="200",method="GET",route="/metrics",} 0.009780743
# HELP vertx_eventbus_handlers Number of event bus handlers in use
# TYPE vertx_eventbus_handlers gauge
vertx_eventbus_handlers 1.0
# HELP vertx_http_server_request_bytes_max Size of requests in bytes
# TYPE vertx_http_server_request_bytes_max gauge
vertx_http_server_request_bytes_max{method="GET",} 0.0
# HELP vertx_http_server_request_bytes Size of requests in bytes
# TYPE vertx_http_server_request_bytes summary
vertx_http_server_request_bytes_count{method="GET",} 5.0
vertx_http_server_request_bytes_sum{method="GET",} 0.0
# HELP vertx_http_server_active_requests Number of requests being processed
# TYPE vertx_http_server_active_requests gauge
vertx_http_server_active_requests{method="GET",} 1.0
# HELP vertx_eventbus_received_total Number of messages received
# TYPE vertx_eventbus_received_total counter
vertx_eventbus_received_total{side="local",} 1.0
# HELP vertx_http_server_requests_total Number of processed requests
# TYPE vertx_http_server_requests_total counter
vertx_http_server_requests_total{code="200",method="GET",route="/greeting",} 1.0
vertx_http_server_requests_total{code="200",method="GET",route="/metrics",} 4.0
# HELP vertx_http_server_active_connections Number of opened connections to the server
# TYPE vertx_http_server_active_connections gauge
vertx_http_server_active_connections 1.0
# HELP vertx_http_server_bytes_written_total Number of bytes sent by the server
# TYPE vertx_http_server_bytes_written_total counter
vertx_http_server_bytes_written_total 14335.0
# HELP vertx_eventbus_delivered_total Number of messages delivered to handlers
# TYPE vertx_eventbus_delivered_total counter
vertx_eventbus_delivered_total{side="local",} 1.0
# HELP vertx_eventbus_sent_total Number of messages sent (point-to-point)
# TYPE vertx_eventbus_sent_total counter
vertx_eventbus_sent_total{side="local",} 1.0
# HELP vertx_eventbus_processed_total Number of processed messages
# TYPE vertx_eventbus_processed_total counter
vertx_eventbus_processed_total{side="local",} 1.0
# HELP vertx_http_server_response_bytes_max Size of responses in bytes
# TYPE vertx_http_server_response_bytes_max gauge
vertx_http_server_response_bytes_max{code="200",method="GET",route="/greeting",} 11.0
vertx_http_server_response_bytes_max{code="200",method="GET",route="/metrics",} 3740.0
# HELP vertx_http_server_response_bytes Size of responses in bytes
# TYPE vertx_http_server_response_bytes summary
vertx_http_server_response_bytes_count{code="200",method="GET",route="/greeting",} 1.0
vertx_http_server_response_bytes_sum{code="200",method="GET",route="/greeting",} 11.0
vertx_http_server_response_bytes_count{code="200",method="GET",route="/metrics",} 4.0
vertx_http_server_response_bytes_sum{code="200",method="GET",route="/metrics",} 14324.0

----

// FIXME: generate some load

== Scraping with Prometheus

If you're not familiar with Prometheus, check out the link:https://prometheus.io/docs/prometheus/latest/getting_started/[getting started guide].

You need to configure the Prometheus server to scrape `localhost:8080`.

[source,yaml]
----
  - job_name: 'vertx-8080'
    static_configs:
      - targets: ['localhost:8080']
----

To run a pre-configured Prometheus server on your machine with Docker, clone the repository of this tutorial, open your terminal and execute this:

[source,bash]
----
docker run --network host -v ${PWD}/prometheus:/etc/prometheus -it prom/prometheus
----

== Visualizing with Grafana

If you're not familiar with Grafana, check out the link:https://grafana.com/docs/grafana/latest/guides/getting_started/[getting started guide].

To run a Grafana server on your machine with Docker, clone the repository of this tutorial, open your terminal and execute this:

[source,bash]
----
docker run --network host -it grafana/grafana
----

As a starting point, you can import the dashboard from `grafana/Vertx-Prometheus.json`.
You should see something like:

.Dashboard
image:grafana/dashboard.png[Dashboard]


== Summary

This document covered:

. setting up Vert.x to expose metrics for Prometheus,
. visualizing metric data in Grafana.

== See also

- https://vertx.io/docs/vertx-micrometer-metrics/java/[Vert.x Micrometer Metrics documentation]
